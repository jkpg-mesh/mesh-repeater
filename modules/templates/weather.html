<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Weather Data</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='webui.css') }}">
    <script src="{{ url_for('static', filename='plotly-3.1.0.min.js') }}"></script>
</head>
<body>
    <div class="container">
        <h1>ğŸŒ¤ï¸ Weather Data Graph</h1>
        <div id="metChart" style="width:100%; max-width:100%; height: 400px;"></div>

        <div class="nav-container">
            <a href="{{ url_for('setup') }}" class="nav-link">Setup âš™ï¸</a>
            <a href="{{ url_for('nodes') }}" class="nav-link">Nodes ğŸ§­</a>
            <a href="{{ url_for('logfile') }}" class="nav-link">Log Files ğŸ“</a>
            <a href="{{ url_for('activity') }}" class="nav-link">Activity ğŸ“‹</a>
            <a href="{{ url_for('gps_ui') }}" class="nav-link">GPS ğŸ›°ï¸</a>
            <a href="{{ url_for('messages') }}" class="nav-link">Messages ğŸ’¬</a>
            <a href="{{ url_for('index') }}" class="nav-link">Home ğŸ </a>
        </div>
    </div>

    <script>
        // Data from Flask context
        const metData = {{ met_data|tojson }};

        if (!metData || metData.length === 0) {
            document.getElementById('metChart').innerHTML = "No data available";
        } else {
            // Use ISO date strings so Plotly recognizes them
            const labels = metData.map(e => new Date(e.timestamp * 1000).toISOString());
            const temp1 = metData.map(e => e.temp1);
            const temp2 = metData.map(e => e.temp2);
            const pressure = metData.map(e => e.pressure_station);
            const humidity = metData.map(e => e.humidity);

            const traceTemp1 = {
                x: labels,
                y: temp1,
                name: 'AHT Temp (Â°C)',
                type: 'scatter',
                mode: 'lines+markers',
                line: { color: 'rgba(255, 99, 132, 1)', shape: 'spline' },
                yaxis: 'y1',
                showlegend: true  // force legend in v3
            };

            const traceTemp2 = {
                x: labels,
                y: temp2,
                name: 'BMP Temp (Â°C)',
                type: 'scatter',
                mode: 'lines+markers',
                line: { color: 'rgba(255, 159, 64, 1)', shape: 'spline' },
                yaxis: 'y1',
                showlegend: true  // force legend in v3
            };

            const tracePressure = {
                x: labels,
                y: pressure,
                name: 'Pressure (hPa)',
                type: 'scatter',
                mode: 'lines+markers',
                line: { color: 'rgba(54, 162, 235, 1)', shape: 'spline' },
                yaxis: 'y2',
                showlegend: true  // force legend in v3
            };

            const traceHumidity = {
                x: labels,
                y: humidity,
                name: 'Humidity (%)',
                type: 'scatter',
                mode: 'lines+markers',
                line: { color: 'rgba(75, 192, 192, 1)', shape: 'spline' },
                yaxis: 'y3',
                showlegend: true  // force legend in v3
            };

            const data = [traceTemp1, traceTemp2, tracePressure /*, traceHumidity */];

            const layout = {
                legend: { orientation: 'h', x: 0, y: 1.1 },
                margin: { t: 60, r: 60, b: 60, l: 60 },
                xaxis: {
                    title:{text: 'Time'} ,
                    type: 'date',
                    showgrid: true,
                    tickangle: -45
                },
                yaxis: {
                    title: {text: 'Temperature (Â°C)'},
                    side: 'left',
                    zeroline: false
                },
                yaxis2: {
                    title: {text: 'Pressure (hPa)'},
                    side: 'right',
                    zeroline: false,
                    overlaying: 'y',
                },
                // yaxis3: {
                //     title: 'Humidity (%)',
                //     side: 'left',
                //     zeroline: false,
                //     overlaying: 'y',
                //     position: 0.05
                // }
            };

            Plotly.newPlot('metChart', data, layout, {responsive: true});
        }
    </script>
</body>
</html>
